name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-bottles:
    name: Build ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: macos
            arch: arm64
            runner: macos-14
            bottle_tag: arm64_sonoma
          - os: macos
            arch: x86_64
            runner: macos-13
            bottle_tag: sonoma

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Run tests
        run: cargo test --release

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create bottle structure
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BOTTLE_DIR="qstack/$VERSION"

          # Create Homebrew-style directory structure
          mkdir -p "$BOTTLE_DIR/bin"
          cp target/release/qstack "$BOTTLE_DIR/bin/"

          # Generate shell completions
          "$BOTTLE_DIR/bin/qstack" completions bash > "$BOTTLE_DIR/qstack.bash"
          "$BOTTLE_DIR/bin/qstack" completions zsh > "$BOTTLE_DIR/_qstack"
          "$BOTTLE_DIR/bin/qstack" completions fish > "$BOTTLE_DIR/qstack.fish"

          mkdir -p "$BOTTLE_DIR/share/bash-completion/completions"
          mkdir -p "$BOTTLE_DIR/share/zsh/site-functions"
          mkdir -p "$BOTTLE_DIR/share/fish/vendor_completions.d"

          mv "$BOTTLE_DIR/qstack.bash" "$BOTTLE_DIR/share/bash-completion/completions/qstack"
          mv "$BOTTLE_DIR/_qstack" "$BOTTLE_DIR/share/zsh/site-functions/_qstack"
          mv "$BOTTLE_DIR/qstack.fish" "$BOTTLE_DIR/share/fish/vendor_completions.d/qstack.fish"

      - name: Create bottle tarball
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BOTTLE_TAG=${{ matrix.bottle_tag }}

          tar -czf "qstack--${VERSION}.${BOTTLE_TAG}.bottle.tar.gz" qstack

          # Calculate SHA256
          shasum -a 256 "qstack--${VERSION}.${BOTTLE_TAG}.bottle.tar.gz" > "qstack--${VERSION}.${BOTTLE_TAG}.bottle.tar.gz.sha256"

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bottle-${{ matrix.bottle_tag }}
          path: |
            qstack--*.bottle.tar.gz
            qstack--*.bottle.tar.gz.sha256

  release:
    name: Create Release
    needs: build-bottles
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bottles
          merge-multiple: true

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: bottles/*
          generate_release_notes: true
          draft: false

      - name: Prepare bottle info
        id: bottles
        run: |
          cd bottles
          echo "arm64_sha=$(cat qstack--${{ steps.version.outputs.version }}.arm64_sonoma.bottle.tar.gz.sha256 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "x86_64_sha=$(cat qstack--${{ steps.version.outputs.version }}.sonoma.bottle.tar.gz.sha256 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Output bottle info
        run: |
          echo "## Bottle SHA256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add this to your formula:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```ruby' >> $GITHUB_STEP_SUMMARY
          echo "bottle do" >> $GITHUB_STEP_SUMMARY
          echo '  root_url "https://github.com/domzilla/qstack/releases/download/${{ github.ref_name }}"' >> $GITHUB_STEP_SUMMARY
          echo '  sha256 cellar: :any_skip_relocation, arm64_sonoma: "${{ steps.bottles.outputs.arm64_sha }}"' >> $GITHUB_STEP_SUMMARY
          echo '  sha256 cellar: :any_skip_relocation, sonoma: "${{ steps.bottles.outputs.x86_64_sha }}"' >> $GITHUB_STEP_SUMMARY
          echo "end" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  update-formula:
    name: Update Homebrew Formula
    needs: [build-bottles, release]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bottles
          merge-multiple: true

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Calculate source SHA256
        id: source
        run: |
          curl -sL "https://github.com/domzilla/qstack/archive/refs/tags/${{ github.ref_name }}.tar.gz" -o source.tar.gz
          echo "sha256=$(shasum -a 256 source.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Get bottle SHA256s
        id: bottles
        run: |
          cd bottles
          echo "arm64_sha=$(cat qstack--${{ steps.version.outputs.version }}.arm64_sonoma.bottle.tar.gz.sha256 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "x86_64_sha=$(cat qstack--${{ steps.version.outputs.version }}.sonoma.bottle.tar.gz.sha256 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: domzilla/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ github.ref_name }}
          SOURCE_SHA=${{ steps.source.outputs.sha256 }}
          ARM64_SHA=${{ steps.bottles.outputs.arm64_sha }}
          X86_64_SHA=${{ steps.bottles.outputs.x86_64_sha }}

          cat > homebrew-tap/Formula/qstack.rb << 'FORMULA'
          class Qstack < Formula
            desc "Minimal, scriptable task and issue tracker for agent-driven workflows"
            homepage "https://github.com/domzilla/qstack"
            url "https://github.com/domzilla/qstack/archive/refs/tags/TAG_PLACEHOLDER.tar.gz"
            sha256 "SOURCE_SHA_PLACEHOLDER"
            license "MIT"
            head "https://github.com/domzilla/qstack.git", branch: "master"

            bottle do
              root_url "https://github.com/domzilla/qstack/releases/download/TAG_PLACEHOLDER"
              sha256 cellar: :any_skip_relocation, arm64_sonoma: "ARM64_SHA_PLACEHOLDER"
              sha256 cellar: :any_skip_relocation, sonoma: "X86_64_SHA_PLACEHOLDER"
            end

            depends_on "rust" => :build

            def install
              system "cargo", "install", *std_cargo_args

              generate_completions_from_executable(bin/"qstack", "completions")
            end

            test do
              system bin/"qstack", "--version"
              system bin/"qstack", "init"
            end
          end
          FORMULA

          # Replace placeholders
          sed -i "s|TAG_PLACEHOLDER|${TAG}|g" homebrew-tap/Formula/qstack.rb
          sed -i "s|SOURCE_SHA_PLACEHOLDER|${SOURCE_SHA}|g" homebrew-tap/Formula/qstack.rb
          sed -i "s|ARM64_SHA_PLACEHOLDER|${ARM64_SHA}|g" homebrew-tap/Formula/qstack.rb
          sed -i "s|X86_64_SHA_PLACEHOLDER|${X86_64_SHA}|g" homebrew-tap/Formula/qstack.rb

      - name: Commit and push formula
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/qstack.rb
          git commit -m "Update qstack to ${{ steps.version.outputs.version }}"
          git push
